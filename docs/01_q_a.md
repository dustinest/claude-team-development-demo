# 01_q_a.md - Q/A Testing Instructions

## Overview

This document provides comprehensive testing instructions for the Fractional Stock Trading Platform.

## Test Environment Setup

### Prerequisites
- Docker and Docker Compose installed
- At least 8GB RAM available
- Ports 5432, 6379, 8080-8090, 9092 available

### Starting the System
```bash
# From project root directory, build all services
./gradlew clean build

# Start all infrastructure and services
docker-compose up --build

# Wait 2-3 minutes for:
# - PostgreSQL to initialize
# - Kafka to start
# - All services to connect
# - Database migrations to run
```

### Verify All Services Are Running
```bash
# Check all containers are up
docker-compose ps

# Check health endpoints
curl http://localhost:8080/q/health  # API Gateway
curl http://localhost:8081/q/health  # Securities Pricing
curl http://localhost:8085/q/health  # User Service
curl http://localhost:8086/q/health  # Wallet Service
curl http://localhost:8087/q/health  # Trading Service
```

All should return `{"status":"UP"}`.

## Test Cases

### TC-001: User Registration
**Objective:** Verify user signup generates UUID and broadcasts event

**Steps:**
1. Navigate to http://localhost:8080/swagger-ui
2. Expand POST /api/v1/signup
3. Click "Try it out"
4. Enter test data:
```json
{
  "email": "trader1@example.com",
  "username": "trader1",
  "phoneNumber": "+1234567890"
}
```
5. Click "Execute"

**Expected Result:**
- Status: 201 Created
- Response includes UUID userId
- Response includes email, username
- Save the userId for subsequent tests

**Verify Event Processing:**
```bash
# Check user was created in database (use `docker ps` to find container name)
docker exec <project-name>-user-service-1 \
  curl -s http://localhost:8080/api/v1/users/{userId}
```

**Pass Criteria:**
- ✅ UUID generated
- ✅ User created event published
- ✅ User Service consumed event and persisted user

### TC-002: Wallet Deposit (USD)
**Objective:** Verify funds can be deposited

**Steps:**
1. POST /api/v1/wallets/{userId}/deposit
2. Body:
```json
{
  "currency": "USD",
  "amount": 1000.00
}
```

**Expected Result:**
- Status: 200 OK
- Response shows wallet balance
- userId, currency, balance fields present

**Verify:**
```bash
# Check balance
GET /api/v1/wallets/{userId}/balances
```

**Pass Criteria:**
- ✅ Balance = 1000.00 USD
- ✅ DepositCompletedEvent published
- ✅ Transaction recorded in history

### TC-003: View Securities List
**Objective:** Verify securities pricing service returns all securities

**Steps:**
1. GET /api/v1/securities

**Expected Result:**
- Status: 200 OK
- Returns array of 20 securities
- 10 stocks (AAPL, GOOGL, MSFT, etc.)
- 5 stock indexes (SPY, QQQ, DIA, etc.)
- 5 bond indexes (AGG, TLT, BND, etc.)
- Each has: symbol, name, type, currentPrice, lastUpdated

**Pass Criteria:**
- ✅ All 20 securities returned
- ✅ Prices are positive numbers
- ✅ lastUpdated timestamp present

### TC-004: Buy Fractional Shares (By Amount)
**Objective:** Verify fractional buy order execution

**Steps:**
1. GET /api/v1/securities/AAPL - Note current price
2. POST /api/v1/trades/buy
```json
{
  "userId": "{userId}",
  "symbol": "AAPL",
  "currency": "USD",
  "orderType": "BY_AMOUNT",
  "amount": 100.00
}
```

**Expected Result:**
- Status: 200 OK
- Trade completed
- Quantity calculated (fractional, 2 decimals)
- Fees shown
- Total amount ≈ 100.00

**Manual Calculation:**
- Get AAPL price (e.g., $175.50)
- Fees: 1% + $0.50
- Amount after fees: $100 - $0.50 - ($99.50 * 0.01) = ~$98.51
- Quantity: $98.51 / $175.50 = 0.56 shares (rounded up, customer favor)

**Pass Criteria:**
- ✅ Trade status = COMPLETED
- ✅ Quantity has max 2 decimal places
- ✅ Fees calculated correctly
- ✅ TradeCompletedEvent published
- ✅ Wallet balance reduced
- ✅ Portfolio updated

### TC-005: Buy Fractional Shares (By Quantity)
**Objective:** Verify buy order by specifying quantity

**Steps:**
1. POST /api/v1/trades/buy
```json
{
  "userId": "{userId}",
  "symbol": "MSFT",
  "currency": "USD",
  "orderType": "BY_QUANTITY",
  "quantity": 0.75
}
```

**Expected Result:**
- Quantity = exactly 0.75
- Total = (0.75 * price) + fees
- Wallet balance reduced by total

**Pass Criteria:**
- ✅ Exact quantity purchased
- ✅ Total amount calculated correctly

### TC-006: View Portfolio
**Objective:** Verify portfolio shows holdings

**Steps:**
1. GET /api/v1/portfolios/{userId}

**Expected Result:**
- Status: 200 OK
- Array of holdings
- Each holding: symbol, quantity, averagePrice, currency
- AAPL and MSFT present from previous buys

**Pass Criteria:**
- ✅ All holdings displayed
- ✅ Quantities match trades
- ✅ Average prices calculated

### TC-007: Sell Fractional Shares
**Objective:** Verify sell order execution

**Steps:**
1. POST /api/v1/trades/sell
```json
{
  "userId": "{userId}",
  "symbol": "AAPL",
  "currency": "USD",
  "orderType": "BY_QUANTITY",
  "quantity": 0.25
}
```

**Expected Result:**
- Trade completed
- Wallet balance increased (price * quantity - fees)
- Portfolio quantity reduced

**Pass Criteria:**
- ✅ Trade status = COMPLETED
- ✅ Funds credited to wallet
- ✅ Portfolio updated
- ✅ Amount rounded in customer's favor (rounded up)

### TC-008: Wallet Withdrawal
**Objective:** Verify funds can be withdrawn

**Steps:**
1. GET /api/v1/wallets/{userId}/balances - Check current balance
2. POST /api/v1/wallets/{userId}/withdraw
```json
{
  "currency": "USD",
  "amount": 50.00
}
```

**Expected Result:**
- Status: 200 OK
- Balance reduced by 50.00

**Pass Criteria:**
- ✅ Balance updated correctly
- ✅ WithdrawalCompletedEvent published
- ✅ Transaction recorded

### TC-009: Currency Exchange
**Objective:** Verify currency conversion

**Steps:**
1. Deposit 500 EUR
2. POST /api/v1/wallets/{userId}/exchange
```json
{
  "fromCurrency": "USD",
  "toCurrency": "EUR",
  "amount": 100.00
}
```

**Expected Result:**
- USD balance reduced by 100.00
- EUR balance increased (converted amount - fees)
- Exchange rate applied
- Fee shown

**Pass Criteria:**
- ✅ Both balances updated
- ✅ Exchange rate realistic
- ✅ Fees applied
- ✅ CurrencyExchangedEvent published

### TC-010: Transaction History
**Objective:** Verify complete audit trail

**Steps:**
1. GET /api/v1/transactions/{userId}

**Expected Result:**
- All transactions listed:
  - Deposits
  - Withdrawals
  - Buys
  - Sells
  - Currency exchanges
- Each shows: type, currency, amount, fees, timestamp
- Ordered by timestamp (newest first recommended)

**Pass Criteria:**
- ✅ All operations recorded
- ✅ Fees shown for each
- ✅ Timestamps present
- ✅ Metadata descriptive

### TC-011: Multi-Currency Deposit
**Objective:** Verify deposits in different currencies

**Steps:**
1. POST /api/v1/wallets/{userId}/deposit - GBP 500
2. POST /api/v1/wallets/{userId}/deposit - EUR 500
3. GET /api/v1/wallets/{userId}/balances

**Expected Result:**
- 3 separate balance entries (USD, EUR, GBP)
- Each shows correct amount

**Pass Criteria:**
- ✅ Separate balances per currency
- ✅ No cross-contamination

### TC-012: Insufficient Funds Handling
**Objective:** Verify trade fails with insufficient funds

**Steps:**
1. Attempt to buy $10,000 of stock with only $100 balance

**Expected Result:**
- Status: 400 Bad Request
- Error message: "Insufficient funds"
- No trade created
- Balance unchanged

**Pass Criteria:**
- ✅ Graceful error handling
- ✅ No partial state changes

### TC-013: Price Updates
**Objective:** Verify securities prices update

**Steps:**
1. GET /api/v1/securities/AAPL - Note price and lastUpdated
2. Wait 35 seconds (price update interval is 30s)
3. GET /api/v1/securities/AAPL - Note new price and lastUpdated

**Expected Result:**
- Price changed slightly (±2%)
- lastUpdated timestamp updated

**Pass Criteria:**
- ✅ Prices fluctuate realistically
- ✅ Timestamps update

### TC-014: Exchange Rate Updates
**Objective:** Verify rates update

**Steps:**
1. GET /api/v1/exchange/rates/USD/EUR - Note rate
2. Wait 65 seconds
3. GET /api/v1/exchange/rates/USD/EUR - Note new rate

**Expected Result:**
- Rate changed slightly (±0.5%)

**Pass Criteria:**
- ✅ Rates fluctuate

### TC-015: Customer-Favorable Rounding
**Objective:** Verify rounding benefits customer

**Steps:**
1. Buy shares where calculation results in fractional quantity
   - Example: $100 / $175.33 = 0.5704... should round to 0.58
2. Sell shares and verify proceeds rounded up

**Pass Criteria:**
- ✅ Buy quantities rounded up (customer gets more shares)
- ✅ Sell proceeds rounded up (customer gets more money)

## Integration Tests

### Event Flow Test
**Objective:** Verify complete event-driven flow

**Steps:**
1. Monitor Kafka topics:
```bash
# Use `docker ps` to find the Kafka container name
docker exec -it <project-name>-kafka-1 \
  kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic user-events --from-beginning

docker exec -it <project-name>-kafka-1 \
  kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic trading-events --from-beginning
```

2. Execute a trade
3. Verify:
   - Trade event published
   - Portfolio service consumed event
   - Transaction service consumed event
   - Holdings updated
   - Transaction recorded

**Pass Criteria:**
- ✅ Events published to correct topics
- ✅ All subscribers process events
- ✅ No event loss

### Database Consistency Test
**Objective:** Verify data consistency across services

**Steps:**
1. Execute multiple trades
2. Check database:
```sql
-- Connect to postgres (use `docker ps` to find container name)
docker exec -it <project-name>-postgres-1 \
  psql -U trading -d trading

-- Check data
SELECT * FROM users;
SELECT * FROM wallet_balances;
SELECT * FROM trades;
SELECT * FROM holdings;
SELECT * FROM transactions;
```

3. Verify:
   - User exists in users table
   - Balances match wallet operations
   - Trades recorded
   - Holdings aggregate trades correctly
   - Transactions complete audit trail

**Pass Criteria:**
- ✅ No orphaned records
- ✅ Foreign keys valid
- ✅ Aggregates match details

## Performance Tests

### Load Test (Manual)
**Objective:** Verify system handles concurrent requests

**Steps:**
1. Create 10 users
2. Execute 50 trades concurrently (use Apache Bench or similar)
3. Monitor:
   - Response times
   - Error rates
   - Database connections
   - Kafka lag

**Expected:**
- All trades complete successfully
- Response times < 500ms
- No database connection errors

## Regression Test Suite

After any code changes, run:
1. TC-001 through TC-015
2. Event Flow Test
3. Database Consistency Test

## Known Limitations

1. **No Authentication**: userId passed as parameter (intentional for MVP)
2. **No Holdings Validation**: Selling more shares than owned not yet prevented
3. **No Order Limits**: Minimum/maximum trade amounts not enforced
4. **Mock Services**: Prices and rates are simulated
5. **Single Database**: All services share one PostgreSQL instance (dev setup)

## Test Data

### Sample Users
```
email: trader1@example.com, username: trader1, phone: +1234567890
email: trader2@example.com, username: trader2, phone: +1987654321
email: investor@example.com, username: investor1, phone: +1555555555
```

### Sample Test Flows
**Day Trader Flow:**
1. Signup
2. Deposit $5000 USD
3. Buy 10x fractional positions (various stocks)
4. Sell half positions
5. View portfolio and P&L
6. Withdraw profits

**Multi-Currency Flow:**
1. Signup
2. Deposit 1000 USD, 1000 EUR, 1000 GBP
3. Buy stocks in each currency
4. Exchange currencies
5. View multi-currency portfolio
6. Check all transaction history

## Cleanup

After testing:
```bash
# Stop all services
docker-compose down

# Remove volumes (clean slate)
docker-compose down -v

# Remove built artifacts
./gradlew clean
```

## Test Report Template

```
Test Date: YYYY-MM-DD
Tester: Name
Build Version: 1.0.0-SNAPSHOT
Environment: Docker Compose (Local)

Test Results:
- TC-001: ✅ PASS
- TC-002: ✅ PASS
- TC-003: ✅ PASS
...

Issues Found:
1. [None / Description]

Overall Status: ✅ All tests passed / ⚠️ Issues found
```

## Next Steps for Q/A

1. Execute all test cases
2. Document any failures
3. Verify fixes
4. Sign off on release readiness

---

**[As Developer]** Testing instructions complete. System ready for Q/A validation.
