# 02_q_a.md - Q/A Instructions for Step 02 Regression Testing

**Role:** Q/A Specialist
**Phase:** Step 02 - Regression Testing After Bug Fixes
**Date:** 2026-01-12
**From:** Developer
**Status:** READY FOR TESTING

---

## Context

**Previous Phase:** Step 01 Q/A testing discovered 2 critical bugs that prevented basic system functionality.

**Developer Actions (Step 02):** Both critical bugs have been fixed and verified:
- ✅ BUG #1: Flyway migration failure (database tables not created) - FIXED
- ✅ BUG #2: Kafka event flow broken (user persistence failing) - FIXED

**Your Task:** Execute comprehensive regression testing to verify fixes and test remaining functionality.

---

## Step 02 Bug Fixes Summary

### BUG #1: Flyway Migration Failure ✅ FIXED
**What was wrong:** `baseline-on-migrate=true` configuration prevented database migrations from executing on fresh start
**Impact:** All application tables (users, wallet_balances, trades, holdings, transactions) were missing
**Fix applied:** Removed `baseline-on-migrate=true` from 5 service configuration files
**Expected result:** All 12 database tables should be created automatically on fresh docker-compose startup

### BUG #2: Kafka Event Flow Broken ✅ FIXED (2 root causes)
**What was wrong:**
- Missing `@Inject` annotation on userEventsEmitter (events not published)
- Missing `@Blocking` annotation on event consumer (transaction errors)
**Impact:** Users created via signup API were not persisted to database
**Fix applied:** Added both missing annotations
**Expected result:** End-to-end flow working: signup → Kafka → user-service → PostgreSQL

### Developer Self-Testing
✅ TC-001 (User Registration) - PASSED with test user test99@example.com

---

## Your Testing Responsibilities

### Phase 1: Verify Bug Fixes
1. Verify BUG #1 fix: Database tables created on fresh start
2. Verify BUG #2 fix: User registration end-to-end flow working
3. Re-execute TC-001 with fresh test data

### Phase 2: Regression Testing
Execute all remaining test cases from `docs/01_q_a.md`:
- TC-002 through TC-015 (13 test cases)
- Document any new issues discovered
- Note any test cases blocked by known issues

### Phase 3: Final Assessment
- Provide sign-off if system meets acceptance criteria
- OR create Step 03 bug list if additional issues found

---

## System Setup Instructions

### 1. Clean Environment Setup

```bash
# Navigate to project root
cd /Users/margus/Git/claude-team-development-demo

# Stop any running containers and remove volumes (fresh start)
docker-compose down -v

# Verify clean state
docker ps -a | grep claude-team-development
# Should return nothing

# Clean build (optional but recommended)
./gradlew clean build -x test
```

### 2. Start Complete System

```bash
# Start all 15 services
docker-compose up --build -d

# Wait for services to initialize (60 seconds minimum)
# Kafka needs ~30 seconds, services need another 30 seconds
echo "Waiting 60 seconds for services to initialize..."
sleep 60

# Verify all containers running
docker-compose ps
```

**Expected:** 15 containers running (10 microservices + 5 infrastructure/frontend)

### 3. Pre-Flight Verification Checks

#### Check 1: Verify Database Tables Created (BUG #1 Fix)
```bash
docker exec claude-team-development-demo-postgres-1 \
  psql -U trading -d trading -c "\dt"
```

**Expected output:**
```
                      List of relations
 Schema |               Name                | Type  |  Owner
--------+-----------------------------------+-------+---------
 public | fee_rules                         | table | trading
 public | flyway_schema_history_fee         | table | trading
 public | flyway_schema_history_portfolio   | table | trading
 public | flyway_schema_history_trading     | table | trading
 public | flyway_schema_history_transaction | table | trading
 public | flyway_schema_history_user        | table | trading
 public | flyway_schema_history_wallet      | table | trading
 public | holdings                          | table | trading
 public | trades                            | table | trading
 public | transactions                      | table | trading
 public | users                             | table | trading
 public | wallet_balances                   | table | trading
(12 rows)
```

**✅ PASS Criteria:** All 12 tables exist (6 application + 6 flyway_schema_history)
**❌ FAIL Criteria:** Any application table missing (users, wallet_balances, trades, holdings, transactions, fee_rules)

#### Check 2: Verify Kafka Topics Created
```bash
docker exec claude-team-development-demo-kafka-1 \
  kafka-topics --bootstrap-server localhost:9092 --list
```

**Expected output:**
```
__consumer_offsets
trading-events
user-events
wallet-events
```

**✅ PASS Criteria:** All 3 application topics exist (user-events, wallet-events, trading-events)

#### Check 3: Verify API Gateway Health
```bash
curl -s http://localhost:8080/q/health | jq '.'
```

**Expected output:**
```json
{
  "status": "UP",
  "checks": []
}
```

**✅ PASS Criteria:** Returns `{"status":"UP"}`
**❌ FAIL Criteria:** Connection refused or status not UP

---

## Test Case Execution

### TC-001: User Registration (RE-TEST)

**Priority:** CRITICAL
**Purpose:** Verify BUG #2 fix (Kafka event flow)

**Test Steps:**

1. Create new user:
```bash
curl -s -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "qa-test-user@example.com",
    "username": "qatestuser",
    "phoneNumber": "+1111111111"
  }' | jq '.'
```

**Expected Response:**
```json
{
  "userId": "<UUID>",
  "email": "qa-test-user@example.com",
  "username": "qatestuser"
}
```

2. Save the userId from response

3. Wait 3 seconds for event processing:
```bash
sleep 3
```

4. Verify user persisted to database:
```bash
# Replace <UUID> with actual userId from step 1
USER_ID="<UUID>"
docker exec claude-team-development-demo-postgres-1 \
  psql -U trading -d trading \
  -c "SELECT id, email, username, phone_number FROM users WHERE id = '${USER_ID}';"
```

**Expected Result:**
```
                  id                  |         email          |  username   | phone_number
--------------------------------------+------------------------+-------------+--------------
 <UUID>                               | qa-test-user@example.com | qatestuser | +1111111111
(1 row)
```

5. Verify event in Kafka topic:
```bash
docker exec claude-team-development-demo-kafka-1 \
  kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic user-events --from-beginning --max-messages 1 --timeout-ms 5000 2>&1 | grep -v "ERROR\|Processed"
```

**Expected:** JSON event with userId, email, username

**✅ PASS Criteria:**
- API returns 201 with userId
- User exists in database with correct data
- Event exists in Kafka topic

**❌ FAIL Criteria:**
- API returns error
- User not in database (BUG #2 not fixed)
- No event in Kafka topic

---

### TC-002: Wallet Deposit (USD)

**Priority:** HIGH
**Prerequisite:** TC-001 complete (need userId)

**Known Issue:** This test case is currently BLOCKED by API Gateway routing configuration issue (separate from the 2 fixed bugs). The wallet service is healthy and functional, but API Gateway does not proxy wallet endpoints.

**Workaround for Testing:** Call wallet service directly on port 8086:

```bash
# Using userId from TC-001
USER_ID="<UUID from TC-001>"

curl -s -X POST http://localhost:8086/api/v1/wallets/${USER_ID}/deposit \
  -H "Content-Type: application/json" \
  -d '{
    "currency": "USD",
    "amount": 1000.00
  }' | jq '.'
```

**Expected Response:**
```json
{
  "id": "<UUID>",
  "userId": "<UUID>",
  "currency": "USD",
  "balance": 1000.00,
  "updatedAt": "2026-01-12T..."
}
```

**✅ PASS Criteria:** Deposit successful, balance shows 1000.00 USD
**⚠️ BLOCKED:** If testing via API Gateway (port 8080) returns 404
**❌ FAIL Criteria:** Direct call to port 8086 fails (indicates bug in wallet service)

---

### TC-003 through TC-015

For remaining test cases, refer to `docs/01_q_a.md` for detailed instructions.

**Test Case Summary:**
- TC-003: View Securities List
- TC-004: Buy Fractional Shares (By Amount)
- TC-005: Buy Fractional Shares (By Quantity)
- TC-006: View Portfolio
- TC-007: Sell Fractional Shares
- TC-008: Wallet Withdrawal
- TC-009: Currency Exchange
- TC-010: Transaction History
- TC-011: Multi-Currency Deposit
- TC-012: Insufficient Funds Handling
- TC-013: Price Updates
- TC-014: Exchange Rate Updates
- TC-015: Customer-Favorable Rounding

**Testing Strategy:**
1. Execute each test case in order
2. Use workaround (direct service calls) for blocked endpoints if needed
3. Document all results in TEST_REPORT.md
4. Note any new bugs discovered

---

## Test Results Documentation

Update `TEST_REPORT.md` with:

1. **Test Execution Log**
   - Timestamp when testing started
   - System startup results
   - Pre-flight check results

2. **Test Case Results**
   - For each test case: PASSED, FAILED, or BLOCKED
   - Evidence (API responses, database queries, logs)
   - Screenshots if applicable

3. **Bug Reports**
   - Any new bugs discovered
   - Severity (CRITICAL, HIGH, MEDIUM, LOW)
   - Steps to reproduce
   - Expected vs actual behavior

4. **Final Assessment**
   - Overall system status
   - Percentage of tests passed
   - Recommendation (sign-off or Step 03 needed)

---

## Known Issues (Not Blocking Sign-Off)

### Issue #1: API Gateway Routing (TC-002 affected)
- **Status:** Wallet endpoints return 404 via API Gateway
- **Impact:** LOW - Not related to the 2 fixed critical bugs
- **Workaround:** Call services directly by port
- **Can defer to Step 03 or future iteration**

### Issue #2: Service Startup Race Condition
- **Status:** Kafka connection warnings on first startup
- **Impact:** NONE - Services auto-recover after retries
- **No action needed**

### Issue #3: Frontend E2E Testing
- **Status:** Deferred per Product Owner decision
- **Impact:** NONE - Frontend is presentation mock only
- **No action needed**

---

## Acceptance Criteria for Sign-Off

### Must Pass (Critical)
- ✅ All database tables created on fresh start (BUG #1 fix)
- ✅ User registration end-to-end working (BUG #2 fix)
- ✅ TC-001: User Registration
- ✅ TC-003: View Securities
- ✅ TC-004 or TC-005: Buy operation working
- ✅ TC-006: Portfolio tracking working

### Should Pass (High Priority)
- TC-007: Sell operation
- TC-009: Currency exchange
- TC-010: Transaction history

### Can Defer (Lower Priority)
- TC-002: Wallet deposit via API Gateway (known issue)
- TC-013, TC-014: Time-based tests
- TC-015: Rounding verification

### Overall Threshold
**Minimum for Sign-Off:** 70% of test cases passing (10+ out of 15)
**Recommendation:** If 10+ tests pass and no new CRITICAL bugs found, provide sign-off

---

## Q/A Decision Framework

### Scenario 1: All Critical Tests Pass (✅ SIGN OFF)
- BUG #1 and BUG #2 fixes verified
- 10+ test cases passing
- No new CRITICAL bugs
- **Decision:** Provide final sign-off, document known issues

### Scenario 2: New Critical Bugs Found (❌ STEP 03 NEEDED)
- New CRITICAL bug blocking multiple test cases
- Core functionality broken
- **Decision:** Create Step 03 with new bug report, loop back to Developer

### Scenario 3: Minor Issues Found (⚠️ CONDITIONAL SIGN-OFF)
- Some test cases failing but not critical
- API Gateway routing issue confirmed
- **Decision:** Sign off with documented limitations, create optional Step 03 backlog

---

## Communication Template

After completing testing, update `docs/02_discussion.md` with your findings:

```markdown
## Q/A → Developer/PO Final Report

**[As Q/A Specialist - Completed YYYY-MM-DD HH:MM UTC]**

### Test Execution Summary
- **Total Test Cases:** 15
- **Passed:** X
- **Failed:** Y
- **Blocked:** Z

### BUG #1 Verification (Flyway Migration)
- **Status:** VERIFIED FIXED / NOT FIXED
- **Evidence:** [Database table list]

### BUG #2 Verification (Kafka Event Flow)
- **Status:** VERIFIED FIXED / NOT FIXED
- **Evidence:** [TC-001 results]

### New Bugs Discovered
1. [None] / [List new bugs with severity]

### Final Decision
**[SIGN OFF]** / **[STEP 03 REQUIRED]**

### Recommendation
[Your recommendation for next steps]
```

---

## Helpful Commands Reference

### Restart Specific Service
```bash
docker-compose restart user-service
```

### View Service Logs
```bash
docker logs claude-team-development-demo-user-service-1 -f
```

### Check Database Data
```bash
docker exec claude-team-development-demo-postgres-1 \
  psql -U trading -d trading -c "SELECT COUNT(*) FROM users;"
```

### Reset Database (if needed)
```bash
docker-compose down -v
docker-compose up -d
sleep 60
```

---

## Support Information

### If You Get Stuck
1. Check service logs: `docker logs <container-name>`
2. Verify all containers running: `docker-compose ps`
3. Check TEST_REPORT.md for previous bug reports
4. Review Developer's fixes in docs/02_discussion.md

### Contact Points (In Multi-Role Workflow)
- Developer: See docs/02_discussion.md for fix details
- Senior Engineer: See docs/01_se.md for architecture decisions
- Product Owner: See docs/01_discussion.md for requirements

---

## Time Estimate

- **System Setup:** 5 minutes
- **Pre-flight Checks:** 5 minutes
- **TC-001 Re-test:** 5 minutes
- **TC-002 through TC-015:** 45-60 minutes
- **Documentation:** 15 minutes
- **Total:** ~90 minutes

---

**READY TO START:** All documentation in place, system ready for testing.
**NEXT ACTION:** Execute system setup and begin testing per instructions above.

Good luck! The system should be significantly more stable with the 2 critical bugs fixed.
