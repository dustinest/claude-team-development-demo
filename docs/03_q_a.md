# 03_q_a.md - Q/A Testing Instructions for Step 03

**Role:** Q/A Specialist
**Phase:** Step 03 - Schema Isolation Architecture Verification
**Date:** 2026-01-13
**From:** Developer
**Priority:** HIGH - Architectural Changes Implemented

---

## Overview

The Developer has completed the schema isolation architecture implementation as specified by the Senior Engineer. All 6 database-backed services now use separate PostgreSQL schemas for complete data isolation.

**What Changed:**
- Each microservice now has its own dedicated PostgreSQL schema
- Configuration-only changes (no code modifications)
- All Flyway migration errors from Step 02 resolved
- System fully functional with all 15 containers running

**Your Task:**
Execute comprehensive regression testing to verify:
1. All services are running correctly
2. Schema isolation is working as designed
3. End-to-end flows function properly
4. No regressions introduced by architectural changes

---

## Pre-Testing Verification

Before starting tests, verify the system is in the expected state:

### 1. Container Health Check

```bash
docker-compose ps
```

**Expected Result:** All 15 containers with "Up" status:
```
NAME                              STATUS
api-gateway                       Up
currency-exchange-service         Up
fee-service                       Up
frontend                          Up
kafka                             Up (healthy)
portfolio-service                 Up
postgres                          Up (healthy)
redis                             Up (healthy)
securities-pricing-service        Up
trading-service                   Up
transaction-history-service       Up
user-service                      Up
user-signup-service               Up
wallet-service                    Up
zookeeper                         Up (healthy)
```

**If any container is missing or crashed:** STOP - Report to Developer before proceeding.

### 2. Database Schema Verification

```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "\dn"
```

**Expected Result:** 6 service schemas + public schema
```
         List of schemas
            Name             |  Owner
-----------------------------+---------
 fee_service                 | trading
 portfolio_service           | trading
 trading_service             | trading
 transaction_history_service | trading
 user_service                | trading
 wallet_service              | trading
 public                      | postgres
```

**If schemas are missing:** STOP - Report to Developer.

### 3. Table Verification

```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SELECT schemaname, tablename FROM pg_tables
  WHERE schemaname IN ('user_service', 'wallet_service', 'trading_service',
                       'portfolio_service', 'transaction_history_service', 'fee_service')
  ORDER BY schemaname, tablename;"
```

**Expected Result:** 12 tables total (6 application + 6 flyway_schema_history)

Each schema should have:
- `user_service`: users, flyway_schema_history
- `wallet_service`: wallet_balances, flyway_schema_history
- `trading_service`: trades, flyway_schema_history
- `portfolio_service`: holdings, flyway_schema_history
- `transaction_history_service`: transactions, flyway_schema_history
- `fee_service`: fee_rules, flyway_schema_history

**If table counts don't match:** STOP - Report to Developer.

### 4. Log Cleanliness Check

```bash
docker-compose logs | grep -i "FlywayException"
```

**Expected Result:** No output (no Flyway errors)

**If FlywayException found:** STOP - Report to Developer.

---

## Test Suite - Step 03

Execute all tests in order. Document results for each test case.

### TC-001: User Registration (Smoke Test)

**Purpose:** Verify basic end-to-end flow works after schema isolation changes

**Test Steps:**
```bash
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "qa.test.001@example.com",
    "username": "qa_test_001",
    "phoneNumber": "+1234567890"
  }' -v
```

**Expected Response:**
- HTTP Status: 201 Created (or 200 OK)
- JSON body contains: userId (UUID format), email, username

**Database Verification:**
```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SELECT id, email, username FROM user_service.users
  WHERE email = 'qa.test.001@example.com';"
```

**Expected:** 1 row returned with matching email and username

**Pass Criteria:**
- ✅ API returns success response
- ✅ userId is valid UUID
- ✅ User persisted to user_service.users table
- ✅ Kafka event flow working (signup-service → user-service)

---

### TC-002: Schema Isolation Verification

**Purpose:** Verify services cannot access each other's schemas

**Test Steps:**

**2a. Verify user_service cannot see wallet_service tables:**
```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SET search_path TO user_service;
  SELECT * FROM wallet_balances LIMIT 1;" 2>&1 | grep -i "does not exist"
```

**Expected:** Error message "relation 'wallet_balances' does not exist"

**2b. Verify wallet_service cannot see user_service tables:**
```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SET search_path TO wallet_service;
  SELECT * FROM users LIMIT 1;" 2>&1 | grep -i "does not exist"
```

**Expected:** Error message "relation 'users' does not exist"

**Pass Criteria:**
- ✅ Services cannot access each other's tables via default search path
- ✅ Schema isolation enforced at database level

---

### TC-003: Flyway Migration Independence

**Purpose:** Verify each service manages its own Flyway schema history

**Test Steps:**
```bash
for schema in user_service wallet_service trading_service portfolio_service transaction_history_service fee_service; do
  echo "Checking $schema:"
  docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
    SELECT version, description, success FROM ${schema}.flyway_schema_history
    ORDER BY installed_rank;"
  echo "---"
done
```

**Expected Result for Each Schema:**
- 1 migration record
- version: 1 (or v1)
- success: true

**Pass Criteria:**
- ✅ Each schema has its own flyway_schema_history table
- ✅ All migrations marked as successful
- ✅ No cross-contamination between schemas

---

### TC-004: Service Health Checks

**Purpose:** Verify all services are healthy

**Test Steps:**
```bash
# Check each service health endpoint
for port in 8080 8081 8082 8083 8084 8085 8086 8087 8088 8089; do
  echo "Port $port:"
  curl -s http://localhost:$port/q/health | jq '.status' || echo "N/A"
done
```

**Expected Result:** All services return `"UP"` status

**Pass Criteria:**
- ✅ All 10 Quarkus services (including api-gateway) return UP
- ✅ No connection refused errors
- ✅ All health checks pass

---

### TC-005: Service Restart Resilience

**Purpose:** Verify schema isolation allows services to restart independently

**Test Steps:**
```bash
# Restart user-service
docker-compose restart user-service

# Wait 10 seconds
sleep 10

# Check user-service is up
docker-compose ps user-service

# Check logs for successful Flyway migration
docker-compose logs user-service | grep -i "Successfully validated"
```

**Expected Result:**
- user-service restarts successfully
- Flyway validates existing migrations (doesn't re-run V1)
- Service reaches "Up" status

**Pass Criteria:**
- ✅ Service restarts without errors
- ✅ Flyway recognizes existing schema and migrations
- ✅ No baseline errors
- ✅ Service functional after restart

---

### TC-006: Concurrent Service Startup

**Purpose:** Verify services can start in any order without race conditions

**Test Steps:**
```bash
# Stop all services
docker-compose down

# Start all services simultaneously
docker-compose up -d

# Wait 60 seconds for startup
sleep 60

# Check all containers are up
docker-compose ps
```

**Expected Result:**
- All 15 containers reach "Up" status
- No Flyway errors in logs
- Services start successfully regardless of order

**Pass Criteria:**
- ✅ All containers running
- ✅ No FlywayException errors
- ✅ No startup race conditions

---

### TC-007: Multiple User Registration

**Purpose:** Verify system handles multiple operations correctly

**Test Steps:**
```bash
# Register 5 users
for i in {1..5}; do
  curl -X POST http://localhost:8080/api/v1/signup \
    -H "Content-Type: application/json" \
    -d "{
      \"email\": \"qa.test.multi.$i@example.com\",
      \"username\": \"qa_test_multi_$i\",
      \"phoneNumber\": \"+123456789$i\"
    }" -s | jq '.userId'
  sleep 1
done
```

**Verification:**
```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SELECT COUNT(*) FROM user_service.users
  WHERE email LIKE 'qa.test.multi.%';"
```

**Expected:** COUNT = 5

**Pass Criteria:**
- ✅ All 5 users registered successfully
- ✅ All users persisted to database
- ✅ No duplicate userId errors
- ✅ System handles concurrent operations

---

### TC-008: Public Schema Isolation

**Purpose:** Verify no application data leaked into public schema

**Test Steps:**
```bash
docker exec claude-team-development-demo-postgres-1 psql -U trading -d trading -c "
  SELECT tablename FROM pg_tables
  WHERE schemaname = 'public'
  AND tablename IN ('users', 'wallet_balances', 'trades', 'holdings', 'transactions', 'fee_rules');"
```

**Expected Result:** 0 rows (no application tables in public schema)

**Pass Criteria:**
- ✅ Public schema does not contain any application tables
- ✅ Schema isolation complete

---

### TC-009: API Gateway Routing

**Purpose:** Verify API Gateway correctly routes to all services

**Test Steps:**
```bash
# Test each service endpoint through API Gateway
curl -s http://localhost:8080/q/health | jq '.status'
curl -s http://localhost:8080/api/v1/signup -X POST -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","username":"test","phoneNumber":"+1234567890"}' | jq '.userId'
```

**Expected:**
- Health endpoint: "UP"
- Signup endpoint: Returns userId

**Pass Criteria:**
- ✅ API Gateway healthy
- ✅ Routes traffic correctly
- ✅ No proxy errors

---

### TC-010: Service Log Cleanliness

**Purpose:** Verify no unexpected errors or warnings in logs

**Test Steps:**
```bash
# Check for critical errors
docker-compose logs | grep -i "ERROR" | grep -v "KafkaConsumer" | head -20

# Check for unexpected exceptions
docker-compose logs | grep -i "Exception" | grep -v "Kafka" | head -20
```

**Expected:**
- No critical database errors
- No Flyway exceptions
- Kafka warnings are acceptable (initial connection retries)

**Pass Criteria:**
- ✅ No critical errors in logs
- ✅ No unexpected exceptions
- ✅ System logs are clean

---

## Test Summary Template

After completing all tests, document results:

```
=== STEP 03 Q/A TEST RESULTS ===
Date: YYYY-MM-DD HH:MM UTC
Tester: Q/A Specialist

Pre-Testing Verification:
[ ] All 15 containers running
[ ] All 6 schemas created
[ ] All 12 tables verified
[ ] No Flyway errors in logs

Test Results:
[ ] TC-001: User Registration (Smoke Test)
[ ] TC-002: Schema Isolation Verification
[ ] TC-003: Flyway Migration Independence
[ ] TC-004: Service Health Checks
[ ] TC-005: Service Restart Resilience
[ ] TC-006: Concurrent Service Startup
[ ] TC-007: Multiple User Registration
[ ] TC-008: Public Schema Isolation
[ ] TC-009: API Gateway Routing
[ ] TC-010: Service Log Cleanliness

Overall Status: [PASS / FAIL]

Issues Found:
1. [List any issues discovered]
2. ...

Notes:
[Any additional observations or comments]
```

---

## Pass/Fail Criteria

**PASS Conditions:**
- All 10 test cases pass completely
- All 15 containers running healthy
- All 6 schemas with correct tables
- No Flyway errors
- End-to-end user registration working

**FAIL Conditions:**
- Any test case fails
- Any container crashed or restarting
- Schema isolation not working
- Flyway errors present
- Data in wrong schemas

---

## If Tests Fail

**For Critical Failures:**
1. Document the failing test case
2. Capture error messages and logs
3. Report back to Developer with details
4. Do NOT proceed with additional testing

**For Minor Issues:**
1. Document the issue
2. Continue with remaining tests
3. Provide comprehensive report to Developer

**Log Collection:**
```bash
# Capture full logs if needed
docker-compose logs > step03_full_logs.txt

# Capture specific service logs
docker-compose logs user-service > step03_user_service_logs.txt
```

---

## Expected Outcome

**Success Criteria for Step 03:**
- ✅ All 10 test cases PASS
- ✅ Schema isolation architecture verified
- ✅ No regressions from Step 02 fixes
- ✅ System ready for production use

**Next Steps After PASS:**
- Update `docs/03_discussion.md` with test results
- Mark Step 03 as complete
- System ready for next iteration or production deployment

**Next Steps After FAIL:**
- Document all failures
- Hand back to Developer for fixes
- Increment to Step 04 for bug fixes

---

## Additional Notes

**Architecture Verification:**
This test suite focuses on verifying the schema isolation architecture implemented in Step 03. The key architectural changes are:
- Separate PostgreSQL schema per service
- No shared database schema
- Each service owns its data completely
- Services communicate via APIs/events only

**Testing Philosophy:**
- Verify isolation boundaries are enforced
- Confirm no cross-service database access
- Validate independent service lifecycle
- Ensure architectural patterns are correct

---

**Prepared by:** Developer
**Date:** 2026-01-13 10:30 UTC
**For:** Q/A Specialist
**Status:** Ready for Testing
